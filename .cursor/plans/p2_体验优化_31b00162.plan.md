---
name: P2 体验优化
overview: 在MVP基础上优化用户体验，包括首次引导、撤销重做、干扰节点、实时反馈、动画效果等，提升游戏的可玩性和流畅度。
todos:
  - id: p2-tutorial
    content: 实现首次引导教程系统
    status: pending
  - id: p2-undo-redo
    content: 实现撤销/重做功能
    status: pending
  - id: p2-distractor
    content: 实现干扰节点系统和验证逻辑
    status: pending
  - id: p2-strength-feedback
    content: 优化因果强度实时显示
    status: pending
  - id: p2-drag-animations
    content: 优化拖拽和放置动画效果
    status: pending
  - id: p2-error-toast
    content: 实现错误提示Toast系统
    status: pending
  - id: p2-unlock-animations
    content: 实现关卡解锁动画
    status: pending
  - id: p2-audio
    content: 集成音效系统
    status: pending
  - id: p2-archive-ui
    content: 实现基础因果图鉴UI
    status: pending
  - id: p2-performance
    content: 性能优化和响应式布局
    status: pending
  - id: p2-bugfix
    content: Bug修复和平衡性调整
    status: pending
isProject: false
---

# P2: 体验优化开发计划

## 目标

在 MVP 基础上优化用户体验，提升游戏的可玩性、流畅度和引导性。

## 开发周期

第 3-4 周

## 核心任务

### 1. 首次引导教程系统

**文件路径**：

- `scenes/tutorial/Tutorial.tscn` + `scripts/tutorial/Tutorial.gd`
- `scenes/tutorial/TutorialLevel.tscn`（可选，使用简化关卡）

**功能要点**：

- 分步骤引导：介绍 → 拖拽 → 放置 → 构建链 → 验证 → 理解结果
- 高亮提示：使用 ColorRect 覆盖需要操作的UI元素
- 消息提示：显示操作说明
- 完成标记：保存到 SaveGame，避免重复显示

**实现参考**：`reverse_causality_dev_guide.md` 第 3.2 节

### 2. 撤销/重做系统

**文件路径**：

- `scripts/core/UndoRedoManager.gd`
- 在 `GameMain.gd` 中集成

**功能要点**：

- 记录操作历史（放置、移除节点）
- 支持 Ctrl+Z 撤销、Ctrl+Y 重做
- 限制历史记录数量（MAX_HISTORY = 20）
- UI按钮：撤销/重做按钮（可选）

**数据结构**：

```gdscript
{
  "type": "place" | "remove",
  "data": { "slot_index", "card_id" },
  "timestamp": int
}
```

**实现参考**：`reverse_causality_dev_guide.md` 第 1.5 节

### 3. 干扰节点系统

**文件路径**：

- 扩展 `scripts/data/CauseNode.gd`（添加 is_distractor, distractor_type）
- 更新 `scripts/core/CausalValidator.gd`（检测干扰节点）
- 更新 `scripts/components/CauseCard.gd`（视觉区分）

**功能要点**：

- 标记干扰节点类型：pseudo（伪因果）、reverse（反向因果）、weak（弱因果）
- 视觉区分：干扰节点使用略微偏红的背景色
- 验证时检测：使用干扰节点会导致验证失败或降低评分
- 错误提示：解释为什么这是干扰节点

**实现参考**：`reverse_causality_dev_guide.md` 第 4.1 节

### 4. 因果强度实时显示优化

**文件路径**：

- `scripts/game/GameMain.gd` 中的 `_update_strength_bar()`

**功能要点**：

- 每次放置/移除节点时实时计算当前强度
- 显示进度条和数值（当前/需要）
- 颜色反馈：接近阈值时变绿，不足时变红
- 动画效果：使用 Tween 平滑过渡

**实现参考**：`reverse_causality_dev_guide.md` 第 1.3 节（StrengthBar部分）

### 5. 拖拽动画优化

**文件路径**：

- `scripts/components/CauseCard.gd`
- `scripts/components/ChainSlot.gd`

**优化要点**：

- 拖拽开始时：轻微放大（scale 1.05）+ 半透明
- 悬停槽位时：槽位边框高亮（绿色可放/红色不可放）
- 放置成功：卡片平滑移动到槽位（Tween动画）
- 放置失败：卡片返回原位置（Tween动画）

**实现参考**：`reverse_causality_dev_guide.md` 第 1.4.1、1.4.2 节

### 6. 错误提示优化

**文件路径**：

- `scripts/ui/ErrorToast.gd`（新建）
- 在 `GameMain.gd` 中调用

**功能要点**：

- 验证失败时显示具体错误信息
- Toast 提示：从屏幕顶部滑入，3秒后自动消失
- 错误类型：
  - 因果断裂：显示断裂位置
  - 强度不足：显示当前/需要强度
  - 使用干扰节点：解释干扰类型
  - 重复节点：提示已使用

**UI设计**：

- 红色背景 + 白色文字
- 轻微阴影效果
- 平滑的滑入/滑出动画

### 7. 关卡解锁动画

**文件路径**：

- `scripts/components/LevelCard.gd`
- `scripts/ui/LevelSelect.gd`

**功能要点**：

- 关卡完成时：播放解锁动画（缩放 + 旋转）
- 新关卡解锁：显示"新关卡解锁"提示
- 等级提升：显示等级变化动画（B → A → S）

**动画效果**：

- 使用 AnimationPlayer 或 Tween
- 缩放：1.0 → 1.2 → 1.0
- 旋转：0° → 360°
- 持续时间：0.5秒

### 8. 音效集成

**文件路径**：

- `scripts/core/AudioManager.gd`（全局自动加载）
- `assets/audio/` 目录

**音效列表**：

- `drag.ogg` - 拖拽开始
- `place.ogg` - 放置成功
- `place_fail.ogg` - 放置失败
- `validate.ogg` - 点击验证
- `success.ogg` - 验证成功
- `fail.ogg` - 验证失败
- `unlock.ogg` - 关卡解锁

**实现要点**：

- 使用 AudioStreamPlayer（音效）和 AudioStreamPlayer（背景音乐）
- 音量控制：通过 SaveGame.settings
- 音效池：避免重复播放时重叠

**参考代码**：

```gdscript
# AudioManager.gd
extends Node

var sfx_players: Array[AudioStreamPlayer] = []
const MAX_SFX_PLAYERS = 5

func play_sfx(stream: AudioStream):
    var player = _get_available_player()
    player.stream = stream
    player.play()
```

### 9. 因果图鉴UI（基础版）

**文件路径**：

- `scenes/ui/Archive.tscn` + `scripts/ui/Archive.gd`

**功能要点**：

- 显示已完成的关卡
- 显示每个关卡的最佳因果链
- 显示已解锁的成就（如果有）
- 简单的列表布局

**数据结构**：

- 从 SaveGame.level_progress 读取
- 显示：关卡名称、最佳评分、完成时间

**注意**：完整版因果图鉴（包含共振、世界线日志）在 P3 实现

### 10. 性能优化

**文件路径**：

- 全局优化检查

**优化清单**：

- 关闭不必要的 `_process()` 调用
- 使用对象池管理卡片实例（如果频繁创建/销毁）
- 限制粒子效果数量
- 优化图片资源（使用 WebP 格式）
- 检查内存泄漏（节点是否正确释放）

**性能监控**：

- 添加 FPS 显示（调试模式）
- 监控内存使用

**参考代码位置**：`reverse_causality_dev_guide.md` 第 6.3 节

### 11. 响应式布局优化

**文件路径**：

- `scripts/core/ResponsiveUI.gd`（全局自动加载）

**功能要点**：

- 检测视口大小变化
- 计算缩放比例（基于 1280x720 基准）
- 通知所有 UI 节点调整缩放
- 确保在不同屏幕尺寸下正常显示

**实现参考**：`reverse_causality_dev_guide.md` 第 2.4 节

### 12. Bug 修复与平衡性调整

**任务**：

- 修复 P1 阶段发现的所有 Bug
- 调整关卡难度（required_strength 阈值）
- 调整评分算法（如果需要）
- 优化错误提示文案

## 开发顺序建议

**Week 3**：

1. Day 1-2：首次引导教程
2. Day 3-4：撤销/重做系统
3. Day 5-7：干扰节点系统

**Week 4**：

1. Day 8-9：动画和视觉优化
2. Day 10-11：音效集成
3. Day 12-13：因果图鉴UI + 性能优化
4. Day 14：Bug修复和平衡性调整

## 验收标准

- 新玩家可以通过教程理解游戏玩法
- 可以撤销/重做操作
- 干扰节点有明显的视觉区分和错误提示
- 所有交互都有适当的音效反馈
- 游戏在 Web 环境下流畅运行（60 FPS）
- 在不同屏幕尺寸下正常显示

## 技术债务记录

- 因果共振系统（P3）
- 多解路径检测（P3）
- 世界线日志生成（P3）
- 完整的因果图鉴（P3）

