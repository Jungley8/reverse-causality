---
name: P4 优化与国际化
overview: 在P1-P3基础上，完善Web性能优化、实现多语言支持（i18n）系统，并进行UI美化，提升游戏的可用性、可访问性和视觉体验。
todos:
  - id: p4-preloader
    content: 实现资源预加载系统（Preloader.gd）
    status: completed
  - id: p4-scene-transition
    content: 实现异步场景切换系统（SceneTransition.gd）
    status: completed
  - id: p4-html-optimize
    content: 优化HTML模板和导出配置
    status: completed
  - id: p4-i18n-manager
    content: 实现国际化管理器（I18nManager.gd）
    status: completed
  - id: p4-locale-zh
    content: 创建中文语言包（zh_CN.json）
    status: completed
  - id: p4-locale-en
    content: 创建英文语言包（en_US.json）
    status: completed
  - id: p4-ui-i18n
    content: 更新所有UI脚本使用i18n系统
    status: completed
  - id: p4-theme-system
    content: 创建统一主题系统（theme.tres）
    status: completed
  - id: p4-card-polish
    content: 美化卡片和槽位组件
    status: completed
  - id: p4-button-polish
    content: 优化按钮和交互元素样式
    status: completed
  - id: p4-result-polish
    content: 美化结果面板和图鉴界面
    status: completed
  - id: p4-menu-polish
    content: 美化主菜单界面
    status: completed
  - id: p4-performance-monitor
    content: 实现性能监控工具
    status: completed
  - id: p4-responsive-test
    content: 完善响应式布局和跨设备测试
    status: completed
isProject: false
---

# P4: 优化与国际化开发计划

## 目标

在P1-P3功能基础上，完善Web性能优化、实现多语言支持系统，并进行UI美化，提升游戏的可用性、可访问性和视觉体验。

## 开发周期

第 7-8 周

## 核心任务

### 1. Web性能优化

**文件路径**：

- `scripts/core/Preloader.gd`（新建）- 资源预加载系统
- `scripts/core/SceneTransition.gd`（新建）- 异步场景切换
- `export_templates/web/index.html`（优化）- 优化HTML模板
- `export_presets.cfg`（优化）- 优化导出配置

**优化要点**：

#### 1.1 资源预加载系统

- 预加载关键场景（MainMenu, LevelSelect, GameMain）
- 预加载常用音效资源
- 实现资源池管理，避免重复加载
- 添加加载进度显示

#### 1.2 异步场景切换

- 使用 `ResourceLoader.load_threaded_request()` 实现异步加载
- 添加淡入淡出过渡动画
- 显示加载进度条
- 优化场景切换性能

#### 1.3 HTML模板优化

- 优化加载动画和提示
- 添加错误处理机制
- 优化Canvas渲染设置
- 添加PWA支持（Progressive Web App）

#### 1.4 资源压缩优化

- 检查并优化图片资源（使用WebP格式）
- 优化音频资源（单声道音效，合理采样率）
- 检查资源导入设置
- 减少不必要的资源加载

**参考代码位置**：`reverse_causality_dev_guide.md` 第 6.1、6.2 节

### 2. 多语言支持（i18n）

**文件路径**：

- `scripts/core/I18nManager.gd`（新建）- 国际化管理器
- `data/locales/zh_CN.json`（新建）- 中文语言包
- `data/locales/en_US.json`（新建）- 英文语言包
- 更新所有UI脚本 - 使用I18nManager获取文本

**功能要点**：

#### 2.1 国际化管理器

- 实现语言切换功能
- 支持动态加载语言包
- 提供 `tr(key: String) -> String` 方法
- 保存用户语言偏好到SaveGame

#### 2.2 语言包结构

```json
{
  "ui": {
    "main_menu": {
      "start_game": "开始游戏",
      "continue_game": "继续游戏",
      "archive": "因果图鉴"
    },
    "game": {
      "validate": "验证",
      "clear": "清空",
      "strength": "因果强度"
    }
  },
  "levels": {
    "level_01": "城市系统性崩溃",
    "level_02": "全面禁止通用AI"
  },
  "resonances": {
    "luddite_loop": "卢德循环",
    "black_swan": "黑天鹅事件"
  }
}
```

#### 2.3 UI文本替换

- 更新 `MainMenu.gd` - 使用 `I18nManager.tr()`
- 更新 `LevelSelect.gd` - 替换硬编码文本
- 更新 `GameMain.gd` - 替换所有UI文本
- 更新 `ResultPanel.gd` - 替换评分文案
- 更新 `Archive.gd` - 替换图鉴文本
- 更新 `Tutorial.gd` - 替换教程文本

#### 2.4 语言切换UI

- 在设置界面添加语言选择器
- 或在主菜单添加语言切换按钮
- 实时切换，无需重启

**数据结构**：

```gdscript
# SaveGame.settings
{
  "language": "zh_CN"  # 或 "en_US"
}
```

### 3. UI美化

**文件路径**：

- `themes/default_theme.tres`（新建或优化）- 统一主题资源
- 更新所有场景文件 - 应用主题样式
- `scripts/ui/ThemeManager.gd`（可选）- 主题管理器

**美化要点**：

#### 3.1 统一主题系统

- 创建统一的Theme资源文件
- 定义颜色方案（参考m1.md的配色）
  - 背景：`#0E1117`
  - 主文本：`#E6EDF3`
  - 强因果：`#3FB950`
  - 弱因果：`#D29922`
  - 错误：`#F85149`
- 统一字体设置（Noto Sans SC）
- 统一边框、阴影、圆角样式

#### 3.2 卡片组件美化

- `CauseCard.tscn` - 优化卡片样式
  - 添加轻微描边
  - 优化背景色和文字对比度
  - 拖拽时放大效果（已实现，可优化）
- `ChainSlot.tscn` - 优化槽位样式
  - 悬停时高亮效果
  - 空槽位和已填充的视觉区分

#### 3.3 按钮和交互元素

- 统一按钮样式（圆角、阴影、悬停效果）
- 优化输入框样式
- 添加过渡动画（Tween）

#### 3.4 结果面板美化

- `ResultPanel.tscn` - 优化评分显示
  - 等级图标/徽章设计
  - 进度条动画效果
  - 解锁提示的视觉设计

#### 3.5 图鉴界面美化

- `Archive.tscn` - 优化图鉴布局
  - 卡片式布局优化
  - 标签页切换动画
  - 滚动区域优化

#### 3.6 主菜单美化

- `MainMenu.tscn` - 优化主菜单
  - 标题动画效果
  - 按钮布局和间距优化
  - 背景渐变或纹理（可选）

**参考设计**：`m1.md` 第 E 节（低成本但高级感的美术方案）

### 4. 性能监控与调试

**文件路径**：

- `scripts/core/PerformanceMonitor.gd`（新建）- 性能监控工具

**功能要点**：

- FPS显示（调试模式）
- 内存使用监控
- 资源加载时间统计
- Web平台性能指标收集

### 5. 响应式布局完善

**文件路径**：

- `scripts/core/ResponsiveUI.gd`（已存在，需要完善）

**完善要点**：

- 确保所有UI在不同屏幕尺寸下正常显示
- 移动端适配测试
- 平板设备适配
- 超宽屏适配

## 开发顺序建议

**Week 7**：

1. Day 1-2：Web性能优化（资源预加载、异步场景切换）
2. Day 3-4：多语言支持系统（I18nManager、语言包创建）
3. Day 5-7：UI文本替换（所有脚本使用i18n）

**Week 8**：

1. Day 8-10：UI美化（主题系统、组件样式优化）
2. Day 11-12：性能监控和响应式布局完善
3. Day 13-14：全面测试和Bug修复

## 验收标准

- Web导出后加载时间 < 3秒（首次加载）
- 场景切换流畅，无明显卡顿
- 支持中英文切换，所有文本正确显示
- UI风格统一，视觉效果提升
- 在不同屏幕尺寸下正常显示
- 性能监控工具可以正常使用
- 所有功能在Web环境下正常运行

## 技术债务记录

- 更多语言支持（日文、韩文等）
- 深色/浅色主题切换
- 自定义主题系统
- 高级性能优化（代码分割、懒加载等）

