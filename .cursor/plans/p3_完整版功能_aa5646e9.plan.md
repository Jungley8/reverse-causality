---
name: P3 完整版功能
overview: 实现完整版的高级功能，包括因果共振系统、多解路径检测、世界线日志生成、完整因果图鉴、隐藏关卡等，提升游戏的深度和复玩价值。
todos:
  - id: p3-resonance
    content: 实现因果共振系统和检测逻辑
    status: pending
  - id: p3-multi-path
    content: 实现多解路径检测系统
    status: pending
  - id: p3-world-log
    content: 实现世界线日志生成系统
    status: pending
  - id: p3-archive-full
    content: 实现完整因果图鉴系统（关卡/共振/世界线）
    status: pending
  - id: p3-time-pressure
    content: 实现时空压力系统（可选）
    status: pending
  - id: p3-hidden-levels
    content: 创建隐藏关卡
    status: pending
  - id: p3-challenge-mode
    content: 实现挑战模式（可选）
    status: pending
  - id: p3-share
    content: 实现社交分享功能
    status: pending
  - id: p3-analytics
    content: 实现数据分析系统（可选）
    status: pending
  - id: p3-audio-full
    content: 完善音效库和背景音乐
    status: pending
  - id: p3-polish
    content: 最终打磨和发布准备
    status: pending
isProject: false
---

# P3: 完整版功能开发计划

## 目标

实现完整版的高级功能，提升游戏的深度、复玩价值和叙事感。

## 开发周期

第 5-6 周

## 核心任务

### 1. 因果共振系统

**文件路径**：

- `scripts/core/ResonanceDatabase.gd` - 共振规则数据库
- `scripts/core/ResonanceDetector.gd` - 共振检测器
- 更新 `scripts/game/GameMain.gd` - 集成共振检测

**功能要点**：

- 定义共振模式（pattern）：特定节点序列组合
- 检测玩家构建的因果链是否匹配共振模式
- 应用评分加成（bonus_multiplier）
- 解锁共振图鉴条目
- 显示解锁提示文案

**共振模式示例**：

- "卢德循环"：tech_breakthrough → job_displacement → social_unrest
- "黑天鹅事件"：climate_event → infra_overload → system_collapse
- "信息级联"：misinformation → public_fear → policy_shift

**数据结构**：

```gdscript
{
  "id": "luddite_loop",
  "name": "卢德循环",
  "pattern": ["tech_breakthrough", "job_displacement", "social_unrest"],
  "description": "技术进步 → 失业 → 社会动荡",
  "bonus_multiplier": 1.2,
  "unlock_text": "你重现了 200 年前的经典因果链"
}
```

**实现参考**：`reverse_causality_dev_guide.md` 第 4.2 节

### 2. 多解路径检测系统

**文件路径**：

- 更新 `scripts/data/LevelData.gd`（添加 valid_paths 数组）
- `scripts/core/PathAnalyzer.gd` - 路径分析器
- 更新 `scripts/game/GameMain.gd` - 集成路径检测

**功能要点**：

- 每个关卡定义 3 条有效路径：
  - 主流叙事（难度1，加成1.0x）
  - 隐藏路径（难度2，加成1.3x）
  - 黑天鹅链（难度3，加成1.5x）
- 检测玩家构建的链是否匹配预定义路径
- 首次发现路径给予额外奖励（+20%）
- 在结果面板显示发现的路径名称

**路径匹配逻辑**：

- 严格匹配：节点ID序列完全一致
- 支持部分匹配（可选，P3.5）

**实现参考**：`reverse_causality_dev_guide.md` 第 4.3 节

### 3. 世界线日志生成系统

**文件路径**：

- `scripts/narrative/WorldLogGenerator.gd` - 日志生成器
- `scripts/narrative/WorldLogTemplates.gd` - 日志模板
- 更新 `scripts/ui/Archive.gd` - 显示世界线日志

**功能要点**：

- 根据玩家构建的因果链生成叙事文本
- 使用模板系统填充变量（节点名称、结果等）
- 保存到 SaveGame.archive.world_logs
- 在因果图鉴中展示

**模板示例**：

```
"在这个世界线中，{cause_1}的到来摧毁了旧有的{cause_2}。
当{cause_3}未能跟上技术变革的步伐时，
人类社会迎来了不可避免的{result}..."
```

**生成时机**：

- 关卡完成时自动生成
- 玩家可以在图鉴中查看所有生成的世界线

**实现参考**：`reverse_causality_dev_guide.md` 第 3.1 节（元叙事部分）

### 4. 完整因果图鉴系统

**文件路径**：

- `scenes/ui/Archive.tscn` + `scripts/ui/Archive.gd`（重构）
- `scenes/ui/ResonanceGallery.tscn` + `scripts/ui/ResonanceGallery.gd`（新建）
- `scenes/ui/WorldLogViewer.tscn` + `scripts/ui/WorldLogViewer.gd`（新建）

**功能模块**：

#### 4.1 关卡档案

- 显示所有已完成关卡
- 显示最佳因果链（可视化）
- 显示发现的路径
- 显示完成时间和评分

#### 4.2 共振图鉴

- 显示所有已解锁的共振模式
- 每个共振显示：名称、描述、解锁条件、解锁时间
- 卡片式布局，支持筛选和搜索

#### 4.3 世界线日志

- 列表显示所有生成的世界线日志
- 支持按关卡、时间排序
- 点击查看完整日志内容
- 支持分享功能（复制文本）

**UI设计**：

- 标签页切换：关卡 / 共振 / 世界线
- 搜索和筛选功能
- 响应式布局

### 5. 时空压力系统（可选增强）

**文件路径**：

- 更新 `scripts/data/CausalRule.gd`（添加时间约束）
- 更新 `scripts/core/CausalValidator.gd`（时间验证）

**功能要点**：

- 每个规则定义时间窗口：min_time_gap, max_time_gap, optimal_gap
- 验证时检查节点时间阶段（time_stage）
- 时间跨度不合理时降低因果强度
- 在结果中显示时间质量评分

**时间阶段定义**：

- 0 = early（早期）
- 1 = mid（中期）
- 2 = late（晚期）

**强度修正公式**：

- 间隔过短：×0.5（因果尚未显现）
- 间隔过长：×0.6（因果已衰减）
- 最佳间隔：×1.0
- 其他：线性衰减

**实现参考**：`reverse_causality_dev_guide.md` 第 4.4 节

### 6. 隐藏关卡系统

**文件路径**：

- `data/levels/level_hidden_01.tres`（新建）
- 更新 `scripts/ui/LevelSelect.gd` - 显示隐藏关卡

**解锁条件**：

- 完成所有3个基础关卡
- 至少发现2个共振模式
- 至少发现1条隐藏路径

**隐藏关卡特点**：

- 更复杂的因果关系
- 更多干扰节点
- 需要发现特定共振才能通过

### 7. 挑战模式（可选）

**文件路径**：

- `scenes/game/ChallengeMode.tscn` + `scripts/game/ChallengeMode.gd`

**模式类型**：

- **时间挑战**：限时完成因果链（3分钟）
- **最少步数**：用最少的节点完成因果链
- **完美路径**：必须找到隐藏路径或黑天鹅链

**奖励**：

- 特殊成就
- 额外共振解锁
- 排行榜位置（如果实现）

### 8. 社交分享功能

**文件路径**：

- `scripts/core/ShareManager.gd`

**功能要点**：

- 生成分享图片：包含因果链可视化、评分、世界线日志
- 复制分享文本到剪贴板
- 支持分享到社交媒体（Web API）

**分享内容格式**：

```
我在《逆果溯因》中构建了一条因果链：

技术突破 → 结构性失业 → 社会动荡 → 城市崩溃

评分：S级
发现的路径：主流叙事
解锁共振：卢德循环

#逆果溯因 #推理游戏
```

**技术实现**：

- 使用 Godot 的 `Image` 类生成图片
- 使用 JavaScript 接口调用浏览器剪贴板 API（Web平台）

### 9. 数据分析系统（可选）

**文件路径**：

- `scripts/analytics/GameAnalytics.gd`

**收集数据**：

- 关卡完成率
- 平均尝试次数
- 评分分布
- 最常用节点组合
- 玩家困惑点（失败原因统计）

**用途**：

- 平衡性调整
- 关卡难度优化
- 玩家行为分析

**隐私**：

- 仅收集匿名数据
- 本地存储，不上传服务器（MVP版本）

### 10. 完整音效库

**文件路径**：

- `assets/audio/` 目录扩展

**新增音效**：

- `resonance_unlock.ogg` - 共振解锁
- `path_discover.ogg` - 发现新路径
- `world_log_generate.ogg` - 生成世界线
- `challenge_complete.ogg` - 挑战完成
- `share.ogg` - 分享操作

**背景音乐**：

- `bgm_menu.ogg` - 主菜单
- `bgm_game.ogg` - 游戏进行中
- `bgm_result.ogg` - 结果界面

**实现要点**：

- 音乐淡入淡出切换
- 音量控制集成到设置

### 11. 最终打磨与发布准备

**任务清单**：

- 所有功能测试
- 性能优化（确保60 FPS）
- 内存泄漏检查
- Web兼容性测试（Chrome, Firefox, Safari, Edge）
- 移动端适配（响应式布局）
- 准备宣传素材（截图、GIF、视频）
- 编写游戏说明文档
- 准备 itch.io 页面内容
- 版本号标记和发布

## 开发顺序建议

**Week 5**：

1. Day 1-3：因果共振系统
2. Day 4-5：多解路径检测
3. Day 6-7：世界线日志生成

**Week 6**：

1. Day 8-10：完整因果图鉴UI
2. Day 11-12：隐藏关卡 + 挑战模式
3. Day 13-14：社交分享 + 最终打磨

## 验收标准

- 可以检测并解锁因果共振
- 可以识别不同的解路径并获得奖励
- 可以生成并查看世界线日志
- 因果图鉴完整展示所有内容
- 隐藏关卡可以正常解锁和游玩
- 分享功能可以正常使用
- 游戏可以发布到 itch.io

## 技术债务记录

- 在线排行榜（需要后端支持）
- 多语言支持（i18n）
- 成就系统扩展
- 关卡编辑器（允许玩家创建自定义关卡）

